import React, { useCallback, useEffect, useMemo, useState } from "react";
import { Layout } from "@/components/layout/Layout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { api } from "@/lib/api";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Spinner } from "@/components/ui/spinner";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import {
  CheckCircle2,
  Download,
  Eye,
  Inbox,
  MoreVertical,
  Plus,
  Search,
  Trash2,
  Upload,
  BookOpen,
  Settings2,
  Target,
  Clock,
  LayoutGrid,
  List,
  Sparkles,
  ArrowRight,
  Layers,
  ChevronDown,
  Zap,
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { QuizDetailDialog } from "@/components/formateur/quiz/QuizDetailDialog";

type Formation = { id: number; nom?: string | null };

type QuizListItem = {
  id: number;
  titre: string;
  description?: string | null;
  duree?: number | string | null;
  niveau?: string | null;
  status?: string | null;
  nb_questions?: number | null;
  formation_id?: number | null;
  formation?: Formation | null;
};

type QuizQuestion = {
  id: number;
  question: string;
  type: string;
  astuce?: string | null;
  reponses: { id?: number; reponse: string; correct: boolean }[];
};

type QuizDetail = {
  quiz: QuizListItem;
  questions: QuizQuestion[];
};

function getStatusBadge(status?: string | null) {
  const s = (status || "").toLowerCase();
  switch (s) {
    case 'actif': return <Badge className="bg-emerald-100 text-emerald-700 border-emerald-200 uppercase font-black text-[10px]">Actif</Badge>;
    case 'brouillon': return <Badge className="bg-amber-100 text-amber-700 border-amber-200 uppercase font-black text-[10px]">Brouillon</Badge>;
    case 'inactif': return <Badge className="bg-slate-100 text-slate-700 border-slate-200 uppercase font-black text-[10px]">Inactif</Badge>;
    default: return <Badge className="bg-blue-100 text-blue-700 border-blue-200 uppercase font-black text-[10px]">{s}</Badge>;
  }
}

export default function FormateurQuizManagementPage() {
  const [loading, setLoading] = useState(true);
  const [quizzes, setQuizzes] = useState<QuizListItem[]>([]);
  const [formations, setFormations] = useState<Formation[]>([]);
  const [expandedFormations, setExpandedFormations] = useState<Record<string, boolean>>({});

  // Pagination
  const [page, setPage] = useState(1);
  const [lastPage, setLastPage] = useState(1);
  const [total, setTotal] = useState(0);

  // Filters
  const [search, setSearch] = useState("");
  const [filterNiveau, setFilterNiveau] = useState<string>("");
  const [filterStatus, setFilterStatus] = useState<string>("");
  const [filterFormationId, setFilterFormationId] = useState<string>("");

  // dialogs
  const [createOpen, setCreateOpen] = useState(false);
  const [detailOpen, setDetailOpen] = useState(false);
  const [questionOpen, setQuestionOpen] = useState(false);

  const [selectedQuiz, setSelectedQuiz] = useState<QuizDetail | null>(null);

  const [newQuizData, setNewQuizData] = useState({
    titre: "",
    description: "",
    duree: 30,
    niveau: "débutant",
    formation_id: "",
  });

  const [currentQuestion, setCurrentQuestion] = useState({
    text: "",
    type: "banque de mots",
    astuce: "",
    reponses: [
      { reponse: "", correct: false },
      { reponse: "", correct: false },
    ],
  });

  const fetchQuizzes = async (p = 1) => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      params.append("page", String(p));
      params.append("limit", "10");
      if (search) params.append("search", search);
      if (filterStatus) params.append("status", filterStatus);
      if (filterFormationId) params.append("formation_id", filterFormationId);

      const res = await api.get(`/formateur/quizzes?${params.toString()}`);
      const data = res.data?.data || [];
      const meta = res.data?.meta || {};

      setQuizzes(data);
      setPage(meta.page || 1);
      setLastPage(meta.last_page || 1);
      setTotal(meta.total || data.length);
      
      const newExpanded: Record<string, boolean> = {};
      data.forEach((q: QuizListItem) => {
        newExpanded[q.formation_id || 'unassigned'] = true;
      });
      setExpandedFormations(newExpanded);
    } finally {
      setLoading(false);
    }
  };

  const fetchFormations = async () => {
    try {
      const res = await api.get(`/formateur/formations`);
      setFormations(res.data?.data || res.data || []);
    } catch {
      setFormations([]);
    }
  };

  useEffect(() => {
    fetchQuizzes(1);
  }, [filterFormationId, filterStatus, search]);

  useEffect(() => {
    fetchFormations();
  }, []);

  const handlePageChange = (newPage: number) => {
    if (newPage < 1 || newPage > lastPage) return;
    fetchQuizzes(newPage);
  };

  const groupedQuizzes = useMemo(() => {
     let filtered = quizzes;
     if (filterNiveau) {
        filtered = filtered.filter(q => (q.niveau || "").toLowerCase() === filterNiveau.toLowerCase());
     }
     const groups: Record<string, { formation: Formation | null, items: QuizListItem[] }> = {};
     filtered.forEach(q => {
        const key = q.formation_id ? String(q.formation_id) : 'unassigned';
        if (!groups[key]) groups[key] = { formation: q.formation || null, items: [] };
        groups[key].items.push(q);
     });
     return groups;
  }, [quizzes, filterNiveau]);

  const toggleFormation = (key: string) => {
    setExpandedFormations(prev => ({ ...prev, [key]: !prev[key] }));
  };

  const handleCreateQuiz = async () => {
    await api.post(`/formateur/quizzes`, { ...newQuizData });
    setCreateOpen(false);
    setNewQuizData({ titre: "", description: "", duree: 30, niveau: "débutant", formation_id: "" });
    fetchQuizzes(1);
  };

  const handleDeleteQuiz = async (id: number) => {
    if (!window.confirm("Supprimer ce quiz ?")) return;
    await api.delete(`/formateur/quizzes/${id}`);
    fetchQuizzes(page);
  };

  const updateReponse = (idx: number, patch: Partial<{ reponse: string; correct: boolean }>) => {
    setCurrentQuestion(prev => {
      const copy = [...prev.reponses];
      copy[idx] = { ...copy[idx], ...patch };
      return { ...prev, reponses: copy };
    });
  };

  const handleAddQuestion = async () => {
    if (!selectedQuiz) return;
    await api.post(`/formateur/quizzes/${selectedQuiz.quiz.id}/questions`, { ...currentQuestion });
    setQuestionOpen(false);
    setCurrentQuestion({ text: "", type: "banque de mots", astuce: "", reponses: [{ reponse: "", correct: false }, { reponse: "", correct: false }] });
    openDetail(selectedQuiz.quiz.id);
  };

  return (
    <Layout>
      <div className="min-h-screen bg-[#F8FAFC] pb-20">
        <div className="relative overflow-hidden bg-white border-b border-gray-100 px-8 py-12 md:px-12 md:py-16 shadow-sm mb-10">
            <div className="absolute top-0 right-0 w-64 h-64 bg-[#FEB823]/5 rounded-full -mr-20 -mt-20 blur-3xl"></div>
            <div className="relative z-10 max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div className="space-y-4">
                    <Badge className="bg-[#FEB823]/10 text-[#FEB823] border-[#FEB823]/20 py-1 px-3">
                        <BookOpen className="w-3 h-3 mr-2" /> Management des Quiz
                    </Badge>
                    <h1 className="text-4xl md:text-5xl font-black text-gray-900 tracking-tight">Atelier de <span className="text-[#FEB823]">Conception</span></h1>
                    <p className="text-gray-500 font-medium max-w-2xl text-lg leading-relaxed">Organisez vos quiz pédagogiques par formation pour un suivi optimal.</p>
                </div>
                <Button size="lg" className="bg-[#FEB823] hover:bg-[#FEB823]/90 text-white font-black px-8 rounded-2xl shadow-xl shadow-[#FEB823]/20 h-14" onClick={() => setCreateOpen(true)}>
                    <Plus className="w-5 h-5 mr-2" /> Nouveau Quiz
                </Button>
            </div>
        </div>

        <div className="max-w-7xl mx-auto px-6 space-y-8">
          <Card className="border-none shadow-xl shadow-slate-200/50 rounded-[2.5rem] overflow-hidden bg-white">
            <CardContent className="p-8 grid grid-cols-1 lg:grid-cols-4 gap-4">
                <div className="relative group">
                   <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 group-focus-within:text-[#FEB823]" />
                   <Input value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Rechercher..." className="pl-12 h-14 rounded-2xl bg-gray-50/50 border-gray-100 focus:ring-[#FEB823]/20 focus:border-[#FEB823]" />
                </div>
                <select className="h-14 rounded-2xl bg-gray-50/50 border border-gray-100 px-6 text-sm font-black text-slate-600 focus:ring-[#FEB823]/20 focus:border-[#FEB823] appearance-none" value={filterFormationId} onChange={(e) => setFilterFormationId(e.target.value)}>
                  <option value="">Formations</option>
                  {formations.map(f => <option key={f.id} value={String(f.id)}>{f.nom}</option>)}
                </select>
                <select className="h-14 rounded-2xl bg-gray-50/50 border border-gray-100 px-6 text-sm font-black text-slate-600 focus:ring-[#FEB823]/20" value={filterNiveau} onChange={(e) => setFilterNiveau(e.target.value)}>
                  <option value="">Niveaux</option>
                  <option value="débutant">Débutant</option><option value="intermédiaire">Intermédiaire</option><option value="avancé">Avancé</option>
                </select>
                <select className="h-14 rounded-2xl bg-gray-50/50 border border-gray-100 px-6 text-sm font-black text-slate-600 focus:ring-[#FEB823]/20" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}>
                  <option value="">Statuts</option>
                  <option value="actif">Actif</option><option value="brouillon">Brouillon</option>
                </select>
            </CardContent>
          </Card>

          <div className="space-y-8">
            <AnimatePresence mode="wait">
              {loading ? <div className="py-32 text-center">Chargement...</div> : Object.keys(groupedQuizzes).map((fId, idx) => (
                <motion.div key={fId} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: idx * 0.1 }}>
                  <Card className="border-none shadow-xl rounded-[2.5rem] overflow-hidden bg-white">
                    <div className="bg-slate-50/80 px-10 py-6 border-b flex justify-between items-center cursor-pointer" onClick={() => toggleFormation(fId)}>
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-[1.25rem] bg-white border flex items-center justify-center font-black text-[#FEB823] text-lg">{(groupedQuizzes[fId].formation?.nom || 'S')[0]}</div>
                            <div>
                                <h3 className="font-black text-slate-900 text-lg flex items-center gap-3">{groupedQuizzes[fId].formation?.nom || 'Divers'} <ChevronDown className={`transition-transform ${expandedFormations[fId] ? 'rotate-180 text-[#FEB823]' : ''}`} /></h3>
                                <Badge variant="outline" className="border-[#FEB823]/20 text-[#FEB823] font-bold text-[9px] uppercase px-2">{groupedQuizzes[fId].items.length} Quiz</Badge>
                            </div>
                        </div>
                        <Button variant="outline" size="sm" className="rounded-xl px-6 border-slate-200 text-slate-400 font-black uppercase text-[10px]">{expandedFormations[fId] ? 'Réduire' : 'Afficher'}</Button>
                    </div>
                    {expandedFormations[fId] && <CardContent className="p-0"><Table><TableHeader><TableRow>
                      <TableHead className="font-black text-[9px] uppercase text-slate-300 py-6 pl-10">Titre</TableHead>
                      <TableHead className="font-black text-[9px] uppercase text-slate-300">Statut</TableHead>
                      <TableHead className="font-black text-[9px] uppercase text-slate-300 text-center">Niveau</TableHead>
                      <TableHead className="font-black text-[9px] uppercase text-slate-300 text-center">Détails</TableHead>
                      <TableHead className="font-black text-[9px] uppercase text-slate-300 text-right pr-10">Actions</TableHead>
                    </TableRow></TableHeader><TableBody>{groupedQuizzes[fId].items.map(q => (
                      <TableRow key={q.id} className="border-slate-50 hover:bg-slate-50/50">
                        <TableCell className="py-6 pl-10 font-black text-sm text-slate-800 uppercase">{q.titre}</TableCell>
                        <TableCell>{getStatusBadge(q.status)}</TableCell>
                        <TableCell className="text-center"><Badge variant="outline" className="text-[9px] px-2">{q.niveau}</Badge></TableCell>
                        <TableCell className="text-center font-black text-[10px] text-slate-400 uppercase"><Clock className="inline w-3 h-3 mr-1" />{q.duree}m | {q.nb_questions} Qs</TableCell>
                        <TableCell className="text-right pr-10"><div className="flex justify-end gap-2">
                          <Button variant="ghost" size="icon" className="text-slate-200 hover:text-[#FEB823]" onClick={() => openDetail(q.id)}><Eye className="h-4.5 w-4.5" /></Button>
                          <Button variant="ghost" size="icon" className="text-slate-100 hover:text-rose-500" onClick={() => handleDeleteQuiz(q.id)}><Trash2 className="h-4.5 w-4.5" /></Button>
                        </div></TableCell>
                      </TableRow>
                    ))}</TableBody></Table></CardContent>}
                  </Card>
                </motion.div>
              ))}
            </AnimatePresence>
            {lastPage > 1 && <div className="flex justify-between p-8 bg-white rounded-[2.5rem] border"><div className="font-black text-slate-300 uppercase text-[10px]">Page {page}/{lastPage}</div><div className="flex gap-3">
              <Button variant="outline" className="rounded-xl uppercase text-[10px]" onClick={() => handlePageChange(page - 1)} disabled={page <= 1}>Précédent</Button>
              <Button className="rounded-xl bg-[#FEB823] text-white uppercase text-[10px]" onClick={() => handlePageChange(page + 1)} disabled={page >= lastPage}>Suivant</Button>
            </div></div>}
          </div>
        </div>
      </div>
      <Dialog open={createOpen} onOpenChange={setCreateOpen}><DialogContent className="rounded-[3.5rem] p-0 overflow-hidden outline-none">
        <div className="bg-[#FEB823] p-10 pt-16 text-white"><DialogTitle className="text-3xl font-black uppercase">Initialisation Quiz</DialogTitle></div>
        <div className="p-10 space-y-6 bg-slate-50/30">
          <Input value={newQuizData.titre} onChange={(e) => setNewQuizData(p => ({ ...p, titre: e.target.value }))} placeholder="Titre..." className="h-16 rounded-[1.5rem] font-black" />
          <div className="grid grid-cols-2 gap-4">
            <select className="h-16 rounded-[1.5rem] px-6 font-black" value={newQuizData.niveau} onChange={(e) => setNewQuizData(p => ({ ...p, niveau: e.target.value }))}><option value="débutant">Débutant</option><option value="intermédiaire">Intermédiaire</option><option value="avancé">Avancé</option></select>
            <Input type="number" value={newQuizData.duree} onChange={(e) => setNewQuizData(p => ({ ...p, duree: Number(e.target.value) }))} className="h-16 rounded-[1.5rem] text-center font-black" />
          </div>
          <select className="h-16 rounded-[1.5rem] px-6 font-black" value={newQuizData.formation_id} onChange={(e) => setNewQuizData(p => ({ ...p, formation_id: e.target.value }))}>
            <option value="">Formation...</option>{formations.map(f => <option key={f.id} value={String(f.id)}>{f.nom}</option>)}
          </select>
          <Button className="w-full h-16 rounded-[1.5rem] bg-[#FEB823] text-white font-black uppercase" onClick={handleCreateQuiz}>Créer le défi</Button>
        </div>
      </DialogContent></Dialog>
      <QuizDetailDialog open={detailOpen} onOpenChange={setDetailOpen} selectedQuiz={selectedQuiz} onPublish={handlePublishQuiz} onAddQuestion={() => setQuestionOpen(true)} onDeleteQuestion={handleDeleteQuestion} />
    </Layout>
  );
}
